# 📋 PDF フォント診断ツール 実装計画

スライド共有サービスでの文字化け・太字崩れを事前に検出する，ブラウザベースの PDF 診断ツールの実装計画である．

## 📑 目次

- [技術スタック](#技術スタック)
- [対象とする診断パターン](#対象とする診断パターン)
- [Issue 一覧](#issue-一覧)
- [依存ライブラリ](#依存ライブラリ)
- [ディレクトリ構成案](#ディレクトリ構成案)

## 🔧 技術スタック

| 項目 | 選定 | 理由 |
|------|------|------|
| 言語 | TypeScript | 型安全性の確保 |
| ビルド | Vite | 軽量・高速・GitHub Pages 向き |
| テスト | Vitest | Vite との統合が容易 |
| PDF 解析 | pdf.js (pdfjs-dist) | Apache-2.0，ブラウザ対応，実績豊富 |
| デプロイ | GitHub Pages + Actions | 静的サイト，CI/CD 自動化 |
| ライセンス | MIT | 依存ライブラリはすべてライブラリとして利用 |

## 🔍 対象とする診断パターン

調査ドキュメントで分類した問題パターンのうち，Stage 1（診断のみ）で対応するものを以下に示す．

### 文字化け系

| ID | パターン | 検出方法 | 難易度 |
|----|----------|----------|--------|
| A | フォント未埋め込み | FontDescriptor の FontFile 系キー有無 | 低 |
| B | ToUnicode CMap 欠落（Identity-H/V 使用時） | Encoding + ToUnicode の組み合わせ確認 | 低 |
| C | ToUnicode CMap の康煕部首誤マッピング | CMap ストリーム内容の解析 | 中 |

### 太字崩れ系

| ID | パターン | 検出方法 | 難易度 |
|----|----------|----------|--------|
| F | 疑似ボールド（Tr=2） | コンテンツストリームの Tr オペレータ検出 | 中 |
| G | オフセット二重描画 | テキスト描画位置の重複検出 | 高（Stage 1 では対象外） |
| H | Bold フォント名だが未埋め込み | フォント名の Bold キーワード + 埋め込み確認 | 低 |

### Stage 1 対象外

| ID | パターン | 理由 |
|----|----------|------|
| D | cmap テーブル不整合（Noto Sans JP） | 埋め込みフォント解析が必要 |
| E | MeiryoUI 特殊ケース | サービス側レンダラの問題で PDF 単体では検出困難 |
| G | オフセット二重描画 | 位置解析の複雑さが高い |

## 📝 Issue 一覧

以下の順序で Issue を作成し，実装を進める．

### Issue #1: プロジェクト初期構築

**内容:**
- Vite + TypeScript プロジェクトの作成
- Vitest の導入と設定
- GitHub Actions による GitHub Pages デプロイ設定
- ESLint 設定
- MIT LICENSE ファイルの配置

**完了条件:**
- `npm run dev` でローカル開発サーバが起動する
- `npm run test` でテストランナーが動作する
- `main` ブランチへの push で GitHub Pages にデプロイされる

---

### Issue #2: PDF ファイルドロップ UI

**内容:**
- ドラッグ＆ドロップによる PDF 受け付け領域の実装
- ファイル選択ダイアログからの読み込み対応
- PDF 以外のファイルの拒否処理
- 読み込み完了後に pdfjs-dist で PDFDocumentProxy を取得する

**完了条件:**
- PDF をドロップすると PDFDocumentProxy が取得できる
- PDF 以外のファイルにはエラーメッセージを表示する
- ファイル選択ダイアログからも読み込める

---

### Issue #3: フォント辞書情報の抽出

**内容:**
- pdf.js API を用いて各ページのフォント情報を取得する
- 取得対象: フォント名，Subtype，Encoding，ToUnicode 有無，埋め込み状態
- ページ横断でフォント一覧を集約する（重複排除）

**完了条件:**
- PDFDocumentProxy から全フォントの辞書情報を抽出できる
- フォント一覧が重複なく集約される
- 抽出結果が構造化されたオブジェクトとして返される

---

### Issue #4: パターン A 検出 - フォント未埋め込み

**内容:**
- フォント辞書の埋め込み状態を判定する
- 日本語フォント（CID フォント）で未埋め込みの場合に警告を出す
- リスクレベル: **高**

**判定ロジック:**
- pdf.js が返すフォント情報から `isEmbedded` 相当のフラグを確認する
- Type0 フォントで未埋め込みは文字化けリスクが極めて高い

**完了条件:**
- 未埋め込みフォントを正しく検出する
- 検出結果にフォント名・リスクレベル・説明文が含まれる

---

### Issue #5: パターン B 検出 - ToUnicode CMap 欠落

**内容:**
- Identity-H / Identity-V エンコーディングかつ ToUnicode CMap が存在しないフォントを検出する
- リスクレベル: **高**

**判定ロジック:**
- Encoding が Identity-H または Identity-V であること
- ToUnicode ストリームが存在しないこと
- 上記が同時に成立する場合，テキスト抽出時に文字化けが発生する

**完了条件:**
- 該当パターンのフォントを正しく検出する
- 検出結果にフォント名・エンコーディング名・リスクレベルが含まれる

---

### Issue #6: パターン C 検出 - ToUnicode CMap 康煕部首誤マッピング

**内容:**
- ToUnicode CMap ストリームを解析し，康煕部首などの低優先 Unicode ブロックへのマッピングを検出する
- xdvipdfmx の優先度判定ロジックを参考にする
- リスクレベル: **中**

**判定ロジック:**
- ToUnicode CMap の bfchar / bfrange エントリを解析する
- マッピング先が以下のブロックに該当するかを判定する
  - U+2E80-2EF3: CJK 部首補助
  - U+2F00-2FD5: 康煕部首
  - U+F900-FAFF: CJK 互換漢字
  - U+E000-F8FF: 私用領域
  - U+FB00-FB4F: アルファベット表示形

**完了条件:**
- CMap ストリームの bfchar / bfrange を正しくパースできる
- 低優先ブロックへのマッピングを検出して一覧化する
- 検出件数と具体的なマッピング例を表示する

---

### Issue #7: パターン F 検出 - 疑似ボールド（Tr=2）

**内容:**
- コンテンツストリームから Tr（テキストレンダリングモード）オペレータを検出する
- Tr=2（Fill then Stroke）の使用を疑似ボールドとして警告する
- 関連する w（線幅）オペレータの値も記録する
- リスクレベル: **中**

**判定ロジック:**
- pdf.js の OPS API でオペレータリストを取得する
- `setTextRenderingMode` オペレータで値が 2 のものを検出する
- 直前の `setLineWidth` オペレータの値を関連情報として記録する

**完了条件:**
- Tr=2 の使用を正しく検出する
- 使用されているページ番号と該当フォントを特定する
- 線幅情報も含めて報告する

---

### Issue #8: パターン H 検出 - Bold フォント名 + 未埋め込み

**内容:**
- フォント名に Bold / Heavy / Black などのキーワードを含むが未埋め込みのフォントを検出する
- パターン A の特殊ケースとして扱う
- リスクレベル: **高**

**判定ロジック:**
- BaseFont 名に `Bold`, `Heavy`, `Black`, `W6`, `W7`, `W8`, `W9` を含むか
- かつ未埋め込みであるか

**完了条件:**
- Bold 系フォント名 + 未埋め込みを検出する
- パターン A との関連を明示して報告する

---

### Issue #9: 診断レポート UI

**内容:**
- 検出結果をリスクレベル別（高・中・低）に分類して表示する
- 各指摘項目に対して，ユーザが取りうる対処法を案内する
- フォント一覧テーブルを表示する

**表示する対処法の例:**
- パターン A/H: 「PDF 作成元でフォント埋め込み設定を有効にして再出力してください」
- パターン B: 「PDF 作成ツールの設定で ToUnicode CMap の出力を有効にしてください」
- パターン C: 「pdf-fix-tuc 等のツールで ToUnicode CMap を修正できます」
- パターン F: 「PDF 作成元で実際の Bold フォントを使用して再出力してください」

**完了条件:**
- 全パターンの検出結果が一画面にまとまって表示される
- リスクレベル別に色分けされている
- 各項目に対処法が表示されている

---

### Issue #10: README・ドキュメント整備

**内容:**
- README.md の作成（プロジェクト概要・使い方・開発方法）
- 診断パターンの解説ドキュメント
- CONTRIBUTING ガイド（必要に応じて）

**完了条件:**
- README に概要・使い方・開発手順が記載されている
- 診断パターンの技術的背景が記載されている

## 📦 依存ライブラリ

| ライブラリ | ライセンス | 用途 |
|-----------|-----------|------|
| pdfjs-dist | Apache-2.0 | PDF 解析 |
| vite | MIT | ビルドツール |
| vitest | MIT | テストフレームワーク |
| typescript | Apache-2.0 | 型チェック |

すべてライブラリとして利用し，ソースコードの取り込みは行わない．

## 📁 ディレクトリ構成案

```
pdf-slide-doctor/
├── .github/
│   └── workflows/
│       └── deploy.yml          # GitHub Pages デプロイ
├── src/
│   ├── main.ts                 # エントリポイント
│   ├── ui/
│   │   ├── drop-zone.ts        # ドロップ UI
│   │   └── report.ts           # 診断レポート UI
│   ├── analyzer/
│   │   ├── font-extractor.ts   # フォント辞書抽出
│   │   ├── pattern-a.ts        # 未埋め込み検出
│   │   ├── pattern-b.ts        # ToUnicode 欠落検出
│   │   ├── pattern-c.ts        # 康煕部首誤マッピング検出
│   │   ├── pattern-f.ts        # 疑似ボールド検出
│   │   ├── pattern-h.ts        # Bold 名 + 未埋め込み検出
│   │   └── types.ts            # 型定義
│   └── utils/
│       └── unicode-blocks.ts   # Unicode ブロック判定
├── tests/
│   ├── analyzer/
│   │   ├── pattern-a.test.ts
│   │   ├── pattern-b.test.ts
│   │   ├── pattern-c.test.ts
│   │   ├── pattern-f.test.ts
│   │   └── pattern-h.test.ts
│   └── utils/
│       └── unicode-blocks.test.ts
├── index.html
├── package.json
├── tsconfig.json
├── vite.config.ts
├── vitest.config.ts
├── LICENSE                     # MIT
└── README.md
```
