# 📄 スライド共有サービスにおける PDF フォント問題のまとめと解決アプローチ

「スライドをよくする会」の活動報告記事4本の内容を整理し，問題の構造と解決アプローチを検討する．

## 📑 目次

- [記事群の概要](#記事群の概要)
- [特定された問題の分類](#特定された問題の分類)
- [pdffonts による診断の現状と限界](#pdffonts-による診断の現状と限界)
- [サービス間の比較結果](#サービス間の比較結果)
- [解決アプローチの検討](#解決アプローチの検討)

---

## 📝 記事群の概要

4本の記事は時系列に沿って調査が深化している．サイボウズ社内のスライド公開運用において発見された問題を起点とし，原因の特定と対策の模索が段階的に進められた記録である．

### 🔖 記事1: 制作されたスライドの真の姿を伝えたい（2023年3月）

問題の発見と初期分析を扱う．Speaker Deck へのアップロード時に発生する2つの問題，文字起こしの文字化けと太字の縁取り掠れ，を特定した．`pdffonts` コマンドによる診断手法を提案し，暫定的な対策基準として emb/sub/uni の3項目が全て yes であることを挙げた．

太字問題については，PowerPoint で `Ctrl+B` による太字化を行った際に Bold ウェイトのフォントへ切り替わらず，輪郭線による疑似太字処理がなされるケースが原因であると特定した．OS 環境の違い（Windows と macOS）によって uni フィールドの結果が異なることも発見された．

### 🔖 記事2: SpeakerDeck cybozuinsideout 調査編（2023年10月）

cybozuinsideout アカウントのスライドに対する体系的な目視調査の中間報告である．確認されたスライドは114個（全369個中）で，以下の問題パターンが分類された．

太字の見た目に関する問題としては，太字掠れと半透明部分の色異常がある．文字起こしに関しては，文字が全く出力されないパターン，各国のアルファベットや記号に化けるパターン，箇条書き記号が n や l に変換されるパターン，均等割付けのスペースが反映されるパターンが確認された．

### 🔖 記事3: PDF に含まれるフォント情報からの判定を試みた（2024年4月）

`pdffonts` の出力だけで機械的に問題を判定できるかを検証した記事である．結論として，pdffonts だけでは判定は難しいことが明らかになった．

具体的には以下の知見が得られている．CID Type 0C（日本語フォント）は uni が no になりやすく文字化けしやすい傾向がある．ただし MeiryoUI のように全フォントで uni が yes にもかかわらず文字化けする事例も存在する．ToUnicode CMap の有無が文字化けの決定的な要因とは言えない．同一フォントがページ単位でサブセット埋め込みされるため大量に表示されることがある．太字掠れの機械的検出も困難で，Bold ウェイトの有無だけでは判断できない．

### 🔖 記事4: 3サービスの比較（2024年8月）

同一 PDF を Speaker Deck, SlideShare, Docswell にアップロードして比較した．結果として Docswell が最も優秀で，文字起こし精度，リンク抽出，スライド上のリンククリックの全てで最も良い結果を示した．

Speaker Deck は文字化けと太字掠れの両方が発生する．SlideShare は文字起こし精度は高いがリンク抽出ができず，タイトル40文字以上の制約がある．Docswell はリンクの取り出しにも成功し，ソースコードの改行も保持される．ただし，PDF 自体に問題がある場合（半透明の異常など）は全サービスで同様に異常が発生する．

---

## 🔍 特定された問題の分類

記事群から抽出された問題を構造的に整理すると以下のようになる．

### 🏷️ A. 文字起こし（Transcript）の文字化け

原因は主に PDF 内のフォント情報と Unicode マッピングの不整合にある．症状には複数のパターンが存在する．

- 各国のアルファベットや記号への置換（最も頻出）
- 文字が全く出力されない
- 箇条書き記号の誤変換（n, l への置換）
- 均等割付けに起因するスペースの混入

関連する技術要素は ToUnicode CMap, CMap/cmap 変換テーブル, フォントの埋め込み方式（CID Type 0C vs TrueType）である．

### 🏷️ B. 太字の掠れ（疑似太字問題）

原因は Bold ウェイトのフォントが PDF に含まれず，輪郭線による疑似太字処理がなされている点にある．PowerPoint の `Ctrl+B` や `[B]` ボタンで太字化した際，フォントに Bold バリアントが存在しないと発生する．

### 🏷️ C. 半透明・図形の描画異常

これは PDF エクスポート時点での問題であり，スライド共有サービス側の問題ではない．PowerPoint の PDF エクスポート処理に起因すると考えられる．

### 🏷️ D. リンク情報の喪失

PDF に含まれるハイパーリンク情報が画像変換の過程で失われる．サービスごとの処理方式に依存し，Docswell のみがリンクを維持できている．

---

## ⚙️ pdffonts による診断の現状と限界

`pdffonts` が出力する主要フィールドと問題との対応関係を以下にまとめる．

### 🏷️ 判定に使える情報

- **emb**（埋め込み）: yes でないと表示自体が崩れる可能性がある
- **sub**（サブセット）: 直接的な問題指標にはなりにくい
- **uni**（ToUnicode CMap）: no の場合に文字化けしやすい傾向はあるが，yes でも化ける事例がある
- **type**: CID Type 0C の日本語フォントは化けやすい傾向がある
- **name**: Bold バリアントの有無から太字掠れのリスクを推定できるが確実ではない

### 🏷️ pdffonts だけでは判定できないこと

- uni が yes でも文字化けする事例（MeiryoUI, Meiryo-Bold など）
- Bold ウェイトが存在しても，特定ページのみ疑似太字が使われている可能性
- Bold フォントをさらに `Ctrl+B` で太字化している場合の検出
- ページ単位でどのフォントが使われているかの対応関係

---

## 📊 サービス間の比較結果

記事4の検証結果を整理すると以下のようになる．

- **Speaker Deck**: 文字化け発生，太字掠れ発生，リンク抽出不可，スライド上リンク不可，文字起こしの手動編集は可能
- **SlideShare**: 文字化けなし，太字掠れなし，リンク抽出不可，スライド上リンク不可，タイトル40文字以上の制約あり
- **Docswell**: 文字化けはフォントに依存（一部失敗あり），太字掠れなし，リンク抽出可能，スライド上リンク可能，ソースコード改行保持

---

## 🛠️ 解決アプローチの検討

記事群の知見を踏まえ，ブラウザベースのツールで解決を目指す場合のアプローチを検討する．

### 🏷️ 方針1: 診断ツール（pdffonts 相当のブラウザ実装）

PDF をブラウザ上で解析し，`pdffonts` 相当の情報を抽出する診断ツールを作る方針である．pdf.js を用いれば PDF のフォント情報をブラウザ上で読み取ることが可能と考えられる．

診断項目としては，フォントごとの emb/sub/uni 相当の情報抽出，CID Type 0C フォントの検出と警告，Bold バリアントの有無チェック，ToUnicode CMap の有無と内容の妥当性検証が挙げられる．

ただし，記事3で明らかになったとおり pdffonts の情報だけでは確実な判定ができないため，診断結果は確定的な判定ではなくリスク表示（高/中/低）とするのが現実的である．

### 🏷️ 方針2: PDF の修正ツール（フォント埋め込みの修正）

診断だけでなく修正まで行う方針である．技術的なハードルは高いが，効果は大きい．

考えられる修正処理は以下である．ToUnicode CMap が欠落しているフォントに対して CMap を生成して追加する．疑似太字（輪郭線による太字化）を検出し，可能であれば Bold ウェイトのフォントに置換する．不完全なサブセット埋め込みを検出し，必要な文字を追加する．

ブラウザ上での PDF 書き換えには pdf-lib や類似ライブラリの活用が考えられる．ただし，CMap の生成には元のフォントの文字コード体系の知識が必要であり，完全な自動化は困難である．

### 🏷️ 方針3: 段階的なアプローチ（推奨）

現実的には以下の段階を踏むのが有効と考える．

**第1段階: 診断ツール**として，PDF をドロップすると pdffonts 相当の情報を一覧表示し，既知の問題パターン（CID Type 0C で uni が no, Bold バリアント不在など）を警告する Web アプリを作る．pdf.js でフォントメタデータを抽出する形になる．

**第2段階: 問題の詳細分析**として，ページ単位でどのフォントが使われているかの対応関係を可視化する機能を追加する．これにより，どのページのどの部分が文字化けリスクを持つかを特定しやすくなる．

**第3段階: 修正機能の実装**として，ToUnicode CMap の追加や，疑似太字の検出と警告を行う．フォントの置換についてはライセンスの問題があるため，代替フォント（Noto Sans CJK JP など OFL ライセンスのフォント）の埋め込みを提案する形が現実的である．

### 🏷️ 技術選定の候補

ブラウザのみで動作する前提での技術候補を挙げる．

- **PDF 解析**: pdf.js（Mozilla）によるフォントメタデータの読み取り
- **PDF 編集**: pdf-lib によるフォント埋め込み・CMap 操作
- **フォント解析**: opentype.js によるフォントファイルの解析（CMap テーブルの読み取りなど）
- **UI**: React もしくは素の HTML/JS（配布の容易さを考慮）

### 🏷️ 残課題

- pdffonts の情報だけでは判定しきれないケース（uni が yes でも化ける MeiryoUI 型）への対処
- CID Type 0C フォントの ToUnicode CMap 生成に必要な知識の整理
- フォントライセンスの問題（代替フォントの埋め込みが許容されるか）
- PDF 内部構造の操作に伴うリスク（既存コンテンツの破損）
- Speaker Deck 固有の処理系に起因する問題の解明（他サービスでは問題にならないケースがある）
